{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Receipt",
  "description": "The outcome of a completed run: metadata, usage, trace, and verification.\n\nUse [`Receipt::with_hash`] to compute and attach the canonical SHA-256 hash.",
  "type": "object",
  "properties": {
    "artifacts": {
      "description": "References to artifacts produced during the run.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/ArtifactRef"
      }
    },
    "backend": {
      "description": "Backend that executed the work order.",
      "$ref": "#/$defs/BackendIdentity"
    },
    "capabilities": {
      "description": "Capability manifest reported by the backend.",
      "type": "object",
      "properties": {
        "checkpointing": {
          "$ref": "#/$defs/SupportLevel"
        },
        "hooks_post_tool_use": {
          "$ref": "#/$defs/SupportLevel"
        },
        "hooks_pre_tool_use": {
          "$ref": "#/$defs/SupportLevel"
        },
        "mcp_client": {
          "$ref": "#/$defs/SupportLevel"
        },
        "mcp_server": {
          "$ref": "#/$defs/SupportLevel"
        },
        "session_fork": {
          "$ref": "#/$defs/SupportLevel"
        },
        "session_resume": {
          "$ref": "#/$defs/SupportLevel"
        },
        "streaming": {
          "$ref": "#/$defs/SupportLevel"
        },
        "structured_output_json_schema": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_ask_user": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_bash": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_edit": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_glob": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_grep": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_read": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_web_fetch": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_web_search": {
          "$ref": "#/$defs/SupportLevel"
        },
        "tool_write": {
          "$ref": "#/$defs/SupportLevel"
        }
      },
      "additionalProperties": false
    },
    "meta": {
      "description": "Timing and identity metadata for this run.",
      "$ref": "#/$defs/RunMetadata"
    },
    "mode": {
      "description": "Execution mode used for this run.",
      "$ref": "#/$defs/ExecutionMode",
      "default": "mapped"
    },
    "outcome": {
      "description": "High-level result status.",
      "$ref": "#/$defs/Outcome"
    },
    "receipt_sha256": {
      "description": "Hash of the canonical receipt (filled in by the control plane).",
      "type": [
        "string",
        "null"
      ]
    },
    "trace": {
      "description": "Ordered log of events emitted during the run.",
      "type": "array",
      "items": {
        "$ref": "#/$defs/AgentEvent"
      }
    },
    "usage": {
      "description": "Normalized usage fields (best-effort).",
      "$ref": "#/$defs/UsageNormalized"
    },
    "usage_raw": {
      "description": "Vendor-specific usage payload as reported."
    },
    "verification": {
      "description": "Git-based verification data captured after completion.",
      "$ref": "#/$defs/VerificationReport"
    }
  },
  "required": [
    "meta",
    "backend",
    "capabilities",
    "usage_raw",
    "usage",
    "trace",
    "artifacts",
    "verification",
    "outcome"
  ],
  "$defs": {
    "AgentEvent": {
      "description": "A timestamped event emitted by an agent during a run.",
      "type": "object",
      "properties": {
        "ext": {
          "description": "Extension field for passthrough mode raw data.\n\nIn passthrough mode, this contains the original SDK message\nfor lossless reconstruction. The key `raw_message` contains\nthe verbatim SDK message.",
          "type": [
            "object",
            "null"
          ],
          "additionalProperties": true
        },
        "ts": {
          "type": "string",
          "format": "date-time"
        }
      },
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "message": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "run_started"
            }
          },
          "required": [
            "type",
            "message"
          ]
        },
        {
          "type": "object",
          "properties": {
            "message": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "run_completed"
            }
          },
          "required": [
            "type",
            "message"
          ]
        },
        {
          "type": "object",
          "properties": {
            "text": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "assistant_delta"
            }
          },
          "required": [
            "type",
            "text"
          ]
        },
        {
          "type": "object",
          "properties": {
            "text": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "assistant_message"
            }
          },
          "required": [
            "type",
            "text"
          ]
        },
        {
          "type": "object",
          "properties": {
            "input": true,
            "parent_tool_use_id": {
              "type": [
                "string",
                "null"
              ]
            },
            "tool_name": {
              "type": "string"
            },
            "tool_use_id": {
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "const": "tool_call"
            }
          },
          "required": [
            "type",
            "tool_name",
            "input"
          ]
        },
        {
          "type": "object",
          "properties": {
            "is_error": {
              "type": "boolean"
            },
            "output": true,
            "tool_name": {
              "type": "string"
            },
            "tool_use_id": {
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "const": "tool_result"
            }
          },
          "required": [
            "type",
            "tool_name",
            "output",
            "is_error"
          ]
        },
        {
          "type": "object",
          "properties": {
            "path": {
              "type": "string"
            },
            "summary": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "file_changed"
            }
          },
          "required": [
            "type",
            "path",
            "summary"
          ]
        },
        {
          "type": "object",
          "properties": {
            "command": {
              "type": "string"
            },
            "exit_code": {
              "type": [
                "integer",
                "null"
              ],
              "format": "int32"
            },
            "output_preview": {
              "type": [
                "string",
                "null"
              ]
            },
            "type": {
              "type": "string",
              "const": "command_executed"
            }
          },
          "required": [
            "type",
            "command"
          ]
        },
        {
          "type": "object",
          "properties": {
            "message": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "warning"
            }
          },
          "required": [
            "type",
            "message"
          ]
        },
        {
          "type": "object",
          "properties": {
            "message": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "error"
            }
          },
          "required": [
            "type",
            "message"
          ]
        }
      ],
      "required": [
        "ts"
      ]
    },
    "ArtifactRef": {
      "description": "Reference to an artifact produced during a run (e.g. a patch file).",
      "type": "object",
      "properties": {
        "kind": {
          "description": "Artifact type (e.g. `\"patch\"`, `\"log\"`).",
          "type": "string"
        },
        "path": {
          "description": "Path to the artifact relative to the workspace root.",
          "type": "string"
        }
      },
      "required": [
        "kind",
        "path"
      ]
    },
    "BackendIdentity": {
      "description": "Identifies a backend and its version information.",
      "type": "object",
      "properties": {
        "adapter_version": {
          "description": "Adapter version (your sidecar wrapper version).",
          "type": [
            "string",
            "null"
          ]
        },
        "backend_version": {
          "description": "Backend runtime version (SDK version, CLI version, etc.).",
          "type": [
            "string",
            "null"
          ]
        },
        "id": {
          "description": "Stable backend identifier (e.g. `\"mock\"`, `\"sidecar:node\"`).",
          "type": "string"
        }
      },
      "required": [
        "id"
      ]
    },
    "ExecutionMode": {
      "description": "Execution mode for how ABP processes requests.\n\n- Passthrough: Lossless wrapping - ABP acts as observer/recorder only\n- Mapped: Full dialect translation - ABP translates between dialects",
      "oneOf": [
        {
          "description": "Lossless wrapping mode. ABP passes requests directly to the SDK\nwithout modification. Stream is bitwise-equivalent to direct SDK call\nafter removing ABP framing.",
          "type": "string",
          "const": "passthrough"
        },
        {
          "description": "Full dialect translation mode. ABP translates between different\nagent dialects, potentially modifying requests and responses.",
          "type": "string",
          "const": "mapped"
        }
      ]
    },
    "Outcome": {
      "description": "High-level result status of a run.",
      "type": "string",
      "enum": [
        "complete",
        "partial",
        "failed"
      ]
    },
    "RunMetadata": {
      "description": "Timing and identity metadata for a single run.",
      "type": "object",
      "properties": {
        "contract_version": {
          "description": "Contract version used for this run.",
          "type": "string"
        },
        "duration_ms": {
          "description": "Wall-clock duration in milliseconds.",
          "type": "integer",
          "format": "uint64",
          "minimum": 0
        },
        "finished_at": {
          "description": "Timestamp when the run finished.",
          "type": "string",
          "format": "date-time"
        },
        "run_id": {
          "description": "Unique run identifier.",
          "type": "string",
          "format": "uuid"
        },
        "started_at": {
          "description": "Timestamp when the run started.",
          "type": "string",
          "format": "date-time"
        },
        "work_order_id": {
          "description": "The work order this run fulfilled.",
          "type": "string",
          "format": "uuid"
        }
      },
      "required": [
        "run_id",
        "work_order_id",
        "contract_version",
        "started_at",
        "finished_at",
        "duration_ms"
      ]
    },
    "SupportLevel": {
      "description": "How well a backend supports a given [`Capability`].",
      "oneOf": [
        {
          "type": "string",
          "enum": [
            "native",
            "emulated",
            "unsupported"
          ]
        },
        {
          "description": "Supported in principle, but disabled by policy or environment.",
          "type": "object",
          "properties": {
            "restricted": {
              "type": "object",
              "properties": {
                "reason": {
                  "type": "string"
                }
              },
              "required": [
                "reason"
              ]
            }
          },
          "additionalProperties": false,
          "required": [
            "restricted"
          ]
        }
      ]
    },
    "UsageNormalized": {
      "description": "Best-effort normalized token/cost counters across different backends.",
      "type": "object",
      "properties": {
        "cache_read_tokens": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0
        },
        "cache_write_tokens": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0
        },
        "estimated_cost_usd": {
          "type": [
            "number",
            "null"
          ],
          "format": "double"
        },
        "input_tokens": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0
        },
        "output_tokens": {
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0
        },
        "request_units": {
          "description": "Copilot-style billing.",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "minimum": 0
        }
      }
    },
    "VerificationReport": {
      "description": "Git-based verification data captured after a run completes.",
      "type": "object",
      "properties": {
        "git_diff": {
          "description": "Output of `git diff` in the workspace, if available.",
          "type": [
            "string",
            "null"
          ]
        },
        "git_status": {
          "description": "Output of `git status --porcelain` in the workspace, if available.",
          "type": [
            "string",
            "null"
          ]
        },
        "harness_ok": {
          "description": "Whether the harness (if any) reported success.",
          "type": "boolean"
        }
      },
      "required": [
        "harness_ok"
      ]
    }
  }
}